    #if defined(AT32F4xx)
    
    #elif defined(HC32F46x)
    
    #endif
# V6版本

## 1.系统占用资源统计

### ~~1.1 AT32F403A版本~~

~~目前SystemCoreClock = 72000000，内部高速晶振HSI。参考《system_at32f4xx.c》L78.~~

~~本次使用5个串口。~~

| ~~功能号~~  | ~~中断资源（先占优先级，从优先级）~~ | ~~引脚（TX，RX）~~ | ~~说明~~                                    |
| ----------- | :----------------------------------- | ------------------ | ------------------------------------------- |
| ~~TIM4~~    | ~~1，5~~                             |                    | ~~250us定时中断，主定时器~~                 |
| ~~systick~~ | ~~无~~                               |                    | ~~延时服务~~                                |
| ~~USART1~~  | ~~3，5~~                             | ~~PA9，PA10~~      | ~~默认使用DMA，占用DMA1_CH4, DMA1_CH5~~     |
| ~~USART2~~  | ~~3，4~~                             | ~~PA2，PA3~~       | ~~默认使用DMA，默认占用DMA1_CH7, DMA1_CH6~~ |
| ~~USART3~~  | ~~3，3~~                             | ~~PB10，PB11~~     | ~~默认使用DMA，默认占用DMA1_CH2, DMA1_CH3~~ |
| ~~UART4~~   | ~~3，2~~                             | ~~PC10，PC11~~     | ~~默认使用DMA，默认占用DMA2_CH5, DMA2_CH3~~ |
| ~~UART5~~   | ~~3，1~~                             | ~~PC12，PD2~~      | ~~默认中断~~                                |
| ~~USART6~~  | ~~3，6~~                             | ~~PC6，PC7~~       | ~~默认中断~~                                |
| ~~UART7~~   | ~~3，7~~                             | ~~PE8，PE7~~       | ~~默认中断~~                                |
| ~~UART8~~   | ~~3，8~~                             | ~~PE1，PE0~~       | ~~默认中断~~                                |
| ~~TIM6~~    | ~~0，3~~                             | ~~PC6~~            | ~~语音芯片1~~                               |
| ~~TIM7~~    | ~~0，4~~                             | ~~PC8~~            | ~~语音芯片2~~                               |
| ~~TIM2~~    | ~~0，1~~                             | ~~PA7~~            | ~~38k红外短距发射~~                         |
| ~~TIM5~~    | ~~0，2~~                             |                    | ~~38k红外短距载波~~                         |
| ~~TIM3~~    | ~~0，5~~                             | ~~PB0~~            | ~~38k红外短距接收，输入捕取样，外部中断0~~  |
| SPI2        |                                      |                    | 外部SPI FLASH                               |
| ADC         |                                      |                    |                                             |

### 1.2 HC32F460版本

目前SystemCoreClock = 168000000，外部高速晶振Xtal=8M。

本次使用4个串口。

| 功能号     | 中断资源号，优先级                                    | 引脚（RX，TX） | 说明                                     |
| ---------- | :---------------------------------------------------- | -------------- | ---------------------------------------- |
| TIM41      | 5                                                     |                | 250us定时中断，主定时器                  |
| systick    | 无                                                    |                | 延时服务                                 |
| USART1     | 6(EI)，7(RX)，8(RTO)，9(TX)，10(TX Cmplt)，11(TC)     | PB02，PB01     | 默认使用DMA，占用DMA1_CH1, DMA1_CH0      |
| TIM01  CHA |                                                       |                | USART1 接收超时计时器                    |
| USART2     | 12(EI)，13(RX)，14(RTO)，15(TX)，16(TX Cmplt)，17(TC) | PA10，PA09     | 默认使用DMA，默认占用DMA1_CH2, DMA1_CH3  |
| TIM01  CHB |                                                       |                | USART2 接收超时计时器                    |
| USART3     | 18(EI)，19(RX)，20(RTO)，21(TX)，22(TX Cmplt)，23(TC) | PB13，PB12     | 默认使用DMA，默认占用DMA2_CH1, DMA21_CH0 |
| TIM02  CHA |                                                       |                | USART3 接收超时计时器                    |
| UART4      | 24(EI)，25(RX)，26(RTO)，27(TX)，28(TX Cmplt)，29(TC) | PB07，PB06     | 默认使用DMA，默认占用DMA2_CH2, DMA2_CH3  |
| TIM02  CHB |                                                       |                | USART4 接收超时计时器                    |
| TIM42      | 4,  4                                                 | PA04           | 语音芯片1数据脚                          |
|            |                                                       | PA05           | 语音芯片1忙信号检测脚                    |
| TIMA1      | 0，0                                                  | PA12           | 38k红外短距发射                          |
| TIMA2      | 1，1                                                  |                | 38k红外短距载波                          |
| TIMA3      | 2，2                                                  | PA11           | 38k红外短距接收，输入取样，外部中断      |
|            | 3，3                                                  |                | 外部中断，起始信号检测                   |
| ADC1       |                                                       | PA06           | CH6 - 2.5V基准                           |
|            |                                                       | PA07           | CH7 - 电压采样                           |
|            |                                                       | PA3            | 红外发射管（48K）                        |







## 2.功能概述

### 2.1 开关机

***开机：***

开关机按键按下，延时1s，防误触；

- ​	此时若松开按键，则开机无效，关机；


- ​	此时若保持按键按下，则亮红灯，系统自身维持住电源，马达震动1s，检查是否有更新包；

  ​		此时若按键持续按着，坚持6s后马达震动，等待按键释放，马达关闭，进入BOOT主逻辑

  ​		此时若松开按键，则进入APP；

***关机***：

开关机按键按下，坚持2.5s，马达震动提示，系统关机



### 2.2 定时任务

#### 2.2.1 电台串口服务

有线升级，升级协议参考《华如防务内部互联互通协议规范XXXX》

#### 2.2.2 Zigbee串口升级服务

- 无线升级，升级协议参考《华如防务内部互联互通协议规范XXXX》



电池电压采用内部基准

F1 86 17 45 01 FF FF FF FF 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 FF BB



5A 23 FD 01 1B FF FF F1 86 17 45 01 FF FF FF FF 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 FF BB AA 




## 引脚分配：

| 网络号        | 引脚号 | 功能号                      | 中断号 | 所属模组         | 备注       |
| ------------- | ------ | --------------------------- | ------ | ---------------- | ---------- |
|               |        |                             |        |                  |            |
| LED_1         | PB8    |                             |        | 灯               |            |
| LED_2         | PB7    |                             |        |                  |            |
| BEEP          | PB9    |                             |        |                  |            |
| TTL_TXD       | PA9    | USART1_TX(Func_Grp1 Func32) |        | 上行串口(通讯口) |            |
| TTL_RXD       | PA10   | USART1_RX(Func_Grp1 Func33) |        |                  |            |
| LCD_TX        | PB2    | USART2_TX(Func_Grp1 Func36) |        |                  |            |
| LCD_RX        | PB1    | USART2_RX(Func_Grp1 Func37) |        |                  |            |
| IRA1          | PB5    | TMRA3_CH2                   |        | 前部             |            |
| IRT1          | PB6    |                             |        |                  |            |
| IRA2          | PC14   | TMRA4_CH5                   |        | 左部             | XTAL32_OUT |
| IRT2          | PA1    |                             |        |                  |            |
| IRA3          | PA11   | TMRA1_CH4                   |        | 右部             |            |
| IRT3          | PA12   |                             |        |                  |            |
| IRA4          | PB10   | TMRA2_CH3                   |        | 后部             |            |
| IRT4          | PA3    |                             |        |                  |            |
| FUME_MONITOR1 | PB15   |                             |        |                  |            |
| FUME_EN1      | PB14   |                             |        |                  |            |
| FUME_MONITOR2 | PB13   |                             |        |                  |            |
| FUME_EN2      | PB12   |                             |        |                  |            |
| ALARM_R       | PB00   |                             |        | 告警红色灯       |            |
| ALARM_G       | PA06   |                             |        | 告警绿色灯       |            |
| ALARM_B       | PA07   |                             |        | 告警蓝色灯       |            |
|               |        |                             |        |                  |            |
|               |        |                             |        |                  |            |





### 指示灯：

LED1 - PB8 				高电平亮

LED2 - PA15/TDI		高电平亮，特殊引脚，注意引脚配置





### 输入捕获： 占用中断1-4

TimerA CH 2 3 4 5



串口超时功能

USART1：Timer0 Unit1 A通道  接收超时	DMA1 CH1 CH2   占用中断6-11（EI、RI、RTO、TI、TC、DMA_TC）

USART2：Timer0 Unit1 B通道  接收超时	DMA1 CH3 CH4   占用中断12-17

USART3：Timer0 Unit2 A通道  接收超时	DMA2 CH1 CH2	占用中断18-23

USART4：Timer0 Unit2 B通道  接收超时	DMA2 CH3 CH4	占用中断24-29



# 协议规定：



### **举例：**

#### 3.1 蜂鸣器鸣叫100ms

[2022-03-14 18:13:51.843]# SEND HEX>
5A 07 CE 01 01 90 AA 

[2022-03-14 18:13:51.910]# RECV HEX>
5A 07 CE 01 01 90 AA 



#### 3.2 RGB灯控 

##### 3.2.1 红灯 亮度100 暂时闪10次

5A 09 CE 04 01 64 01 0A AA 

##### 3.2.2 浅蓝灯 亮度80 双闪

5A 09 CE 04 05 50 03 00 AA 

##### 3.2.3 关闭灯控

5A 09 CE 04 00 00 00 00 AA 



3.3 激光发射控制

5A 09 CE 04 00 00 00 00 AA 

